#!/bin/bash
set -e

PR_NUM="$1"
if [ -z "$PR_NUM" ]; then
  PR_NUM=$(gh pr view --json number -q '.number' 2>/dev/null || echo "")
  if [ -z "$PR_NUM" ]; then echo "Error: No PR number" >&2; exit 1; fi
fi

REPO=$(gh repo view --json nameWithOwner -q '.nameWithOwner')
TEMP=$(mktemp)
gh api "repos/$REPO/pulls/$PR_NUM/reviews" \
  --jq '[.[] | select(.user.login == "coderabbitai[bot]")] | max_by(.body | length) | .body // ""' > "$TEMP"

SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"

node --import tsx "$SCRIPT_DIR/lib/cli-parse-review.ts" "$TEMP"
rm -f "$TEMP"
